name: ğŸš€ Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ” Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 89.39.121.224 >> ~/.ssh/known_hosts

      - name: ğŸ“¦ Create deployment archive
        run: |
          tar -czf deploy.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='dist' \
            --exclude='*.log' \
            --exclude='.env' \
            --exclude='uploads' \
            --exclude='logs' \
            --exclude='*.tar.gz' \
            Dockerfile docker-compose.yml .dockerignore \
            package.json package-lock.json prisma src \
            tsconfig.json tsconfig.build.json nest-cli.json

      - name: ğŸ“¤ Upload to server
        run: |
          scp -o StrictHostKeyChecking=no deploy.tar.gz Minus@89.39.121.224:~/

      - name: ğŸš€ Deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no Minus@89.39.121.224 << 'ENDSSH'
            set -e
            
            APP_DIR="/var/www/nest-server"
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
            sudo mkdir -p $APP_DIR
            sudo chown -R Minus:Minus $APP_DIR
            
            cd $APP_DIR
            
            echo "ğŸš€ Starting deployment..."
            
            # Backup
            if [ -d "src" ]; then
              tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz src package.json 2>/dev/null || true
              ls -t backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
            fi
            
            # Extract
            tar -xzf ~/deploy.tar.gz
            rm ~/deploy.tar.gz
            
            # Check .env
            if [ ! -f .env ]; then
              echo "âš ï¸  .env not found, creating from example..."
              cp .env.example .env || echo "âŒ No .env.example found!"
            fi
            
            # Deploy
            docker compose down || true
            docker system prune -f || true
            docker compose build --no-cache
            docker compose up -d
            
            sleep 30
            
            # Health check
            for i in {1..10}; do
              if curl -f http://localhost:3000/health > /dev/null 2>&1; then
                echo "âœ… Healthy!"
                break
              fi
              sleep 5
            done
            
            docker compose ps
            echo "âœ… Deployment completed!"
          ENDSSH

      - name: ğŸ“¢ Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ğŸŒ http://89.39.121.224"
            echo "ğŸ“š http://89.39.121.224/api/docs"
          else
            echo "âŒ Deployment failed!"
          fi